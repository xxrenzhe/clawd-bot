name: SEO Automation

on:
  schedule:
    # Run daily at 6:00 AM UTC (2:00 PM Beijing Time)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      skip_collect:
        description: 'Skip data collection'
        required: false
        type: boolean
        default: false
      skip_articles:
        description: 'Skip article generation'
        required: false
        type: boolean
        default: false
      max_articles:
        description: 'Maximum articles to generate'
        required: false
        type: string
        default: '3'

jobs:
  seo-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        working-directory: website
        run: npm ci

      - name: Create data directories
        working-directory: website
        run: |
          mkdir -p data/knowledge-base
          mkdir -p data/analytics
          mkdir -p data/analysis

      - name: Collect data from external sources
        if: ${{ !inputs.skip_collect }}
        working-directory: website
        run: npx tsx scripts/seo-automation/collect-data.ts
        continue-on-error: true

      - name: Generate trending articles
        if: ${{ !inputs.skip_articles }}
        working-directory: website
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || 'gemini-2.0-flash' }}
          MAX_ARTICLES: ${{ inputs.max_articles || '3' }}
        run: npx tsx scripts/seo-automation/generate-trending-articles.ts
        continue-on-error: true

      - name: Validate generated articles
        if: ${{ !inputs.skip_articles }}
        working-directory: website
        run: npm run validate-seo
        continue-on-error: true

      - name: Build website with new articles
        working-directory: website
        run: npm run build

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: daily SEO automation - new articles [skip ci]"
          file_pattern: |
            website/data/**
            website/src/content/articles/**
          push_options: '--force'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## SEO Automation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f website/data/knowledge-base/collection-summary.json ]; then
            echo "### Knowledge Base" >> $GITHUB_STEP_SUMMARY
            cat website/data/knowledge-base/collection-summary.json >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f website/data/knowledge-base/generated-articles.json ]; then
            echo "### Generated Articles" >> $GITHUB_STEP_SUMMARY
            cat website/data/knowledge-base/generated-articles.json >> $GITHUB_STEP_SUMMARY
          fi
