---
/**
 * Analytics Component
 *
 * Integrates Plausible Analytics with comprehensive conversion tracking:
 * - Hosting CTA clicks (primary conversion goal)
 * - Newsletter signups
 * - Reading depth / engagement
 * - Outbound link clicks
 * - Time on page
 */
const plausibleDomain = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN || 'clawd-bot.app';
const plausibleSrc = import.meta.env.PUBLIC_PLAUSIBLE_SRC || 'https://plausible.io/js/script.js';
const enableClickTracking = import.meta.env.PUBLIC_ENABLE_UI_CLICK_TRACKING === 'true';
---

<!-- Custom event tracking -->
<script
  is:inline
  data-plausible-domain={plausibleDomain}
  data-plausible-src={plausibleSrc}
  data-enable-click-tracking={enableClickTracking ? 'true' : 'false'}
>
  const scriptTag = document.currentScript;
  const PLAUSIBLE_DOMAIN =
    scriptTag?.getAttribute('data-plausible-domain') || 'clawd-bot.app';
  const PLAUSIBLE_SRC =
    scriptTag?.getAttribute('data-plausible-src') || 'https://plausible.io/js/script.js';
  const ENABLE_CLICK_TRACKING =
    scriptTag?.getAttribute('data-enable-click-tracking') === 'true';

  const ensurePlausibleQueue = () => {
    // Initialize plausible queue early so events aren't dropped
    // @ts-ignore - plausible is loaded from external script
    window.plausible = window.plausible || function() {
      // @ts-ignore
      (window.plausible.q = window.plausible.q || []).push(arguments);
    };
  };

  const loadPlausible = () => {
    if (document.querySelector('script[data-plausible="true"]')) return;
    const script = document.createElement('script');
    script.defer = true;
    script.dataset.domain = PLAUSIBLE_DOMAIN;
    script.dataset.plausible = 'true';
    script.src = PLAUSIBLE_SRC;
    document.head.appendChild(script);
  };

  const schedulePlausibleLoad = () => {
    if ('requestIdleCallback' in window) {
      // @ts-ignore - requestIdleCallback is not in all TS libs
      requestIdleCallback(loadPlausible, { timeout: 2000 });
    } else {
      setTimeout(loadPlausible, 800);
    }
  };

  const initTracking = () => {
    ensurePlausibleQueue();
    schedulePlausibleLoad();

    // Initialize plausible function
    const trackEvent = (eventName, props) => {
      // @ts-ignore - plausible is loaded from external script
      // @ts-ignore
      window.plausible(eventName, { props });
    };

    const setupTracking = () => {
    // ==========================================
    // 1. HOSTING CTA CLICKS (Primary Conversion)
    // ==========================================
    document.querySelectorAll('[data-analytics-event="hosting-cta-click"]').forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget;
        if (!target || !(target instanceof HTMLElement)) return;
        const context = target.getAttribute('data-analytics-context') || 'unknown';
        const href = target.getAttribute('href') || '';

        trackEvent('Hosting CTA Click', {
          context,
          url: href,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 2. NEWSLETTER SIGNUPS
    // ==========================================
    document.querySelectorAll('[data-analytics-event="newsletter-signup"]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget;
        if (!target || !(target instanceof HTMLElement)) return;
        const context = target.getAttribute('data-analytics-context') || 'unknown';

        trackEvent('Newsletter Signup', {
          context,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 3. READING DEPTH / SCROLL TRACKING
    // ==========================================
    let maxScroll = 0;
    const milestones = [25, 50, 75, 90];
    const tracked = new Set();
    let scrollHeight = 0;
    let lastKnownScrollY = window.scrollY;
    let isTicking = false;

    const updateScrollMetrics = () => {
      scrollHeight = Math.max(document.documentElement.scrollHeight - window.innerHeight, 1);
    };

    const trackReadingDepth = () => {
      if (scrollHeight <= 0) return;
      const scrollPercent = Math.min(100, Math.round((lastKnownScrollY / scrollHeight) * 100));

      if (scrollPercent > maxScroll) {
        maxScroll = scrollPercent;

        milestones.forEach((milestone) => {
          if (scrollPercent >= milestone && !tracked.has(milestone)) {
            tracked.add(milestone);
            trackEvent('Scroll Depth', {
              depth: `${milestone}%`,
              page: window.location.pathname,
            });
          }
        });
      }
    };

    const onScroll = () => {
      lastKnownScrollY = window.scrollY;
      if (!isTicking) {
        isTicking = true;
        requestAnimationFrame(() => {
          isTicking = false;
          trackReadingDepth();
        });
      }
    };

    updateScrollMetrics();
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', updateScrollMetrics, { passive: true });
    if ('ResizeObserver' in window) {
      const resizeObserver = new ResizeObserver(() => {
        updateScrollMetrics();
      });
      resizeObserver.observe(document.documentElement);
    }

    // ==========================================
    // 4. OUTBOUND LINK CLICKS
    // ==========================================
    document.querySelectorAll('a[href^="http"]').forEach((link) => {
      const anchor = link;
      if (!(anchor instanceof HTMLAnchorElement)) return;
      try {
        const url = new URL(anchor.href);
        if (url.hostname !== window.location.hostname) {
          anchor.addEventListener('click', () => {
            trackEvent('Outbound Link', {
              url: anchor.href,
              text: anchor.textContent?.trim().substring(0, 50) || 'unknown',
              page: window.location.pathname,
            });
          });
        }
      } catch (e) {
        // Invalid URL, ignore
      }
    });

    // ==========================================
    // 5. TIME ON PAGE / ENGAGEMENT
    // ==========================================
    let timeOnPage = 0;
    const engagementMilestones = [
      { seconds: 30, name: '30s' },
      { seconds: 60, name: '1min' },
      { seconds: 180, name: '3min' },
    ];
    const engagementTracked = new Set();

    const engagementInterval = setInterval(() => {
      timeOnPage += 10;

      engagementMilestones.forEach(({ seconds, name }) => {
        if (timeOnPage >= seconds && !engagementTracked.has(name)) {
          engagementTracked.add(name);
          trackEvent('Time on Page', {
            duration: name,
            page: window.location.pathname,
          });
        }
      });

      // Stop tracking after 3 minutes
      if (timeOnPage >= 180) {
        clearInterval(engagementInterval);
      }
    }, 10000);

    // ==========================================
    // 6. EXIT INTENT (Desktop)
    // ==========================================
    const supportsExitIntent = window.matchMedia('(pointer: fine)').matches;
    if (supportsExitIntent) {
      let exitIntentTracked = false;
      document.addEventListener('mouseout', (e) => {
        if (exitIntentTracked) return;
        if (e.clientY <= 0) {
          exitIntentTracked = true;
          trackEvent('Exit Intent', {
            page: window.location.pathname,
            timeOnPage: timeOnPage,
          });
        }
      });
    }

    // ==========================================
    // 7. FORM SUBMISSIONS
    // ==========================================
    document.querySelectorAll('form').forEach((form) => {
      form.addEventListener('submit', () => {
        const formId = form.id || form.className.split(' ')[0] || 'unknown';
        trackEvent('Form Submit', {
          form: formId,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 8. PAGE VISIBILITY (Tab switches)
    // ==========================================
    let tabSwitches = 0;
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        tabSwitches++;
      } else if (tabSwitches > 0) {
        trackEvent('Tab Return', {
          switches: tabSwitches,
          page: window.location.pathname,
        });
      }
    });

    // ==========================================
    // 9. GENERIC CLICK TRACKING (Optional)
    // ==========================================
    if (ENABLE_CLICK_TRACKING) {
      document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.closest('[data-analytics-event]')) return;

        const clickable = target.closest('a, button, [role=\"button\"], [data-analytics-click]');
        if (!(clickable instanceof HTMLElement)) return;

        const tag = clickable.tagName.toLowerCase();
        const href = clickable instanceof HTMLAnchorElement ? clickable.href : '';
        const label = clickable.getAttribute('aria-label')
          || clickable.textContent?.trim().slice(0, 80)
          || clickable.id
          || 'unknown';

        trackEvent('UI Click', {
          tag,
          href,
          label,
          page: window.location.pathname,
        });
      }, { capture: true });
    }
    };

    if ('requestIdleCallback' in window) {
      // @ts-ignore - requestIdleCallback is not in all TS libs
      requestIdleCallback(setupTracking, { timeout: 2000 });
    } else {
      setTimeout(setupTracking, 200);
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTracking, { once: true });
  } else {
    initTracking();
  }
</script>
