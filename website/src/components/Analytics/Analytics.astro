---
/**
 * Analytics Component
 *
 * Integrates Plausible Analytics with comprehensive conversion tracking:
 * - Hosting CTA clicks (primary conversion goal)
 * - Newsletter signups
 * - Reading depth / engagement
 * - Outbound link clicks
 * - Time on page
 */
const plausibleDomain = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN || 'clawd-bot.app';
---

<!-- Plausible Analytics -->
<script
  defer
  data-domain={plausibleDomain}
  src="https://plausible.io/js/script.js"
></script>

<!-- Custom event tracking -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize plausible function
    const trackEvent = (eventName: string, props?: Record<string, any>) => {
      // @ts-ignore - plausible is loaded from external script
      if (typeof plausible !== 'undefined') {
        // @ts-ignore
        plausible(eventName, { props });
      }
    };

    const setupTracking = () => {
    // ==========================================
    // 1. HOSTING CTA CLICKS (Primary Conversion)
    // ==========================================
    document.querySelectorAll('[data-analytics-event="hosting-cta-click"]').forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const context = target.getAttribute('data-analytics-context') || 'unknown';
        const href = (target as HTMLAnchorElement).href || '';

        trackEvent('Hosting CTA Click', {
          context,
          url: href,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 2. NEWSLETTER SIGNUPS
    // ==========================================
    document.querySelectorAll('[data-analytics-event="newsletter-signup"]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        const context = target.getAttribute('data-analytics-context') || 'unknown';

        trackEvent('Newsletter Signup', {
          context,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 3. READING DEPTH / SCROLL TRACKING
    // ==========================================
    let maxScroll = 0;
    const milestones = [25, 50, 75, 90];
    const tracked = new Set<number>();

    const trackReadingDepth = () => {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight - windowHeight;
      if (documentHeight <= 0) return;

      const scrolled = window.scrollY;
      const scrollPercent = Math.round((scrolled / documentHeight) * 100);

      if (scrollPercent > maxScroll) {
        maxScroll = scrollPercent;

        milestones.forEach((milestone) => {
          if (scrollPercent >= milestone && !tracked.has(milestone)) {
            tracked.add(milestone);
            trackEvent('Scroll Depth', {
              depth: `${milestone}%`,
              page: window.location.pathname,
            });
          }
        });
      }
    };

    let scrollTimeout: number;
    const handleScroll = () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = window.setTimeout(trackReadingDepth, 100);
    };
    window.addEventListener('scroll', handleScroll, { passive: true });

    // ==========================================
    // 4. OUTBOUND LINK CLICKS
    // ==========================================
    document.querySelectorAll('a[href^="http"]').forEach((link) => {
      const anchor = link as HTMLAnchorElement;
      try {
        const url = new URL(anchor.href);
        if (url.hostname !== window.location.hostname) {
          anchor.addEventListener('click', () => {
            trackEvent('Outbound Link', {
              url: anchor.href,
              text: anchor.textContent?.trim().substring(0, 50) || 'unknown',
              page: window.location.pathname,
            });
          });
        }
      } catch (e) {
        // Invalid URL, ignore
      }
    });

    // ==========================================
    // 5. TIME ON PAGE / ENGAGEMENT
    // ==========================================
    let timeOnPage = 0;
    const engagementMilestones = [
      { seconds: 30, name: '30s' },
      { seconds: 60, name: '1min' },
      { seconds: 180, name: '3min' },
    ];
    const engagementTracked = new Set<string>();

    const engagementInterval = setInterval(() => {
      timeOnPage += 10;

      engagementMilestones.forEach(({ seconds, name }) => {
        if (timeOnPage >= seconds && !engagementTracked.has(name)) {
          engagementTracked.add(name);
          trackEvent('Time on Page', {
            duration: name,
            page: window.location.pathname,
          });
        }
      });

      // Stop tracking after 3 minutes
      if (timeOnPage >= 180) {
        clearInterval(engagementInterval);
      }
    }, 10000);

    // ==========================================
    // 6. EXIT INTENT (Desktop)
    // ==========================================
    const supportsExitIntent = window.matchMedia('(pointer: fine)').matches;
    if (supportsExitIntent) {
      let exitIntentTracked = false;
      document.addEventListener('mouseout', (e) => {
        if (exitIntentTracked) return;
        if (e.clientY <= 0) {
          exitIntentTracked = true;
          trackEvent('Exit Intent', {
            page: window.location.pathname,
            timeOnPage: timeOnPage,
          });
        }
      });
    }

    // ==========================================
    // 7. FORM SUBMISSIONS
    // ==========================================
    document.querySelectorAll('form').forEach((form) => {
      form.addEventListener('submit', () => {
        const formId = form.id || form.className.split(' ')[0] || 'unknown';
        trackEvent('Form Submit', {
          form: formId,
          page: window.location.pathname,
        });
      });
    });

    // ==========================================
    // 8. PAGE VISIBILITY (Tab switches)
    // ==========================================
    let tabSwitches = 0;
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        tabSwitches++;
      } else if (tabSwitches > 0) {
        trackEvent('Tab Return', {
          switches: tabSwitches,
          page: window.location.pathname,
        });
      }
    });
    };

    if ('requestIdleCallback' in window) {
      // @ts-ignore - requestIdleCallback is not in all TS libs
      requestIdleCallback(setupTracking, { timeout: 2000 });
    } else {
      setTimeout(setupTracking, 200);
    }
  });
</script>
