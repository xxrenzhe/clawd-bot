---
/**
 * RelatedArticles Component
 *
 * Displays related articles to improve internal linking and SEO.
 * Related articles are determined by:
 * 1. Same category
 * 2. Shared keywords
 * 3. Publication date proximity
 */
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

interface Props {
  currentSlug: string;
  category: string;
  keywords?: string[];
  maxArticles?: number;
  title?: string;
}

const {
  currentSlug,
  category,
  keywords = [],
  maxArticles = 3,
  title = 'Related Articles',
} = Astro.props;

const baseUrl = Astro.site?.href || 'https://www.clawd-bot.app';

const allArticles = await getCollection('articles');

// Score articles by relevance
function calculateRelevanceScore(article: CollectionEntry<'articles'>): number {
  let score = 0;

  // Same category: +10 points
  if (article.data.category === category) {
    score += 10;
  }

  // Shared keywords: +2 points each
  const articleKeywords = article.data.keywords || [];
  const sharedKeywords = keywords.filter(kw =>
    articleKeywords.some(ak => ak.toLowerCase().includes(kw.toLowerCase()) || kw.toLowerCase().includes(ak.toLowerCase()))
  );
  score += sharedKeywords.length * 2;

  // Recency bonus: articles within last 30 days get +3
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  if (article.data.pubDate > thirtyDaysAgo) {
    score += 3;
  }

  return score;
}

// Filter and sort articles
const relatedArticles = allArticles
  .filter(article => article.slug !== currentSlug)
  .map(article => ({
    article,
    score: calculateRelevanceScore(article),
  }))
  .filter(item => item.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, maxArticles)
  .map(item => item.article);
---

{relatedArticles.length > 0 && (
  <aside class="related-articles mt-12 border-t border-gray-200/70 pt-8 dark:border-gray-800/70" aria-label="Related articles">
    <h2 class="mb-6 text-2xl font-bold text-gray-900 dark:text-white">{title}</h2>
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 reveal-group">
      {relatedArticles.map((article) => (
        <article class="surface-card group rounded-2xl p-5 transition-all hover:-translate-y-1 hover:shadow-float">
          <a href={`/articles/${article.slug}`} class="block" title={`Read: ${article.data.title}`}>
            <div class="mb-3 flex items-center gap-2">
              <span class="rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                {article.data.category}
              </span>
              <span class="text-xs text-gray-600 dark:text-gray-400">
                {article.data.readingTime} min read
              </span>
            </div>
            <h3 class="mb-2 font-semibold text-gray-900 transition-colors group-hover:text-blue-600 dark:text-white dark:group-hover:text-blue-400 line-clamp-2">
              {article.data.title}
            </h3>
            <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-2">
              {article.data.description}
            </p>
            <div class="mt-3 flex items-center text-sm font-medium text-blue-600 dark:text-blue-400">
              Read article
              <svg class="ml-1 h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </div>
          </a>
        </article>
      ))}
    </div>

    {/* SEO: Add schema markup for related articles */}
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'ItemList',
      name: title,
      numberOfItems: relatedArticles.length,
      itemListElement: relatedArticles.map((article, index) => ({
        '@type': 'ListItem',
        position: index + 1,
        item: {
          '@type': 'Article',
          name: article.data.title,
          url: `${baseUrl.replace(/\/$/, '')}/articles/${article.slug}`,
          description: article.data.description,
        },
      })),
    })} />
  </aside>
)}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
