---
import BaseLayout from './BaseLayout.astro';
import ArticleSchema from '../components/SEO/ArticleSchema.astro';
import BreadcrumbSchema from '../components/SEO/BreadcrumbSchema.astro';
import RelatedArticles from '../components/Articles/RelatedArticles.astro';
import ArticleNavigation from '../components/Articles/ArticleNavigation.astro';
import HostingCTAEnhanced from '../components/CTA/HostingCTAEnhanced.astro';
import NewsletterSignup from '../components/Email/NewsletterSignup.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'articles'>;
}

const { entry } = Astro.props;
const { title, description, keywords, image, imageAlt, pubDate, modifiedDate, author, category, readingTime } = entry.data;
const defaultAuthor = 'Openclaw (Moltbot/Clawdbot) Team';
const authorLower = author?.toLowerCase() || '';
const resolvedAuthor = authorLower.includes('clawdbot') || authorLower.includes('moltbot')
  ? defaultAuthor
  : author || defaultAuthor;
const categoryParam = encodeURIComponent(category);

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Articles', url: '/articles' },
  { name: category, url: `/articles?category=${categoryParam}` },
  { name: title, url: Astro.url.pathname },
];
---

<BaseLayout
  title={title}
  description={description}
  keywords={keywords}
  image={image}
  article={true}
  publishedTime={pubDate}
  modifiedTime={modifiedDate}
  author={resolvedAuthor}
  category={category}
>
  <ArticleSchema
    title={title}
    description={description}
    image={image}
    imageAlt={imageAlt}
    publishedTime={pubDate}
    modifiedTime={modifiedDate}
    author={resolvedAuthor}
    keywords={keywords}
    category={category}
    readingTime={readingTime}
    articleType={category === 'Tutorial' ? 'HowTo' : 'TechArticle'}
  />
  <BreadcrumbSchema items={breadcrumbs} />

  <!-- Breadcrumb Navigation -->
  <nav class="mx-auto max-w-4xl px-4 pt-10 sm:px-6 lg:px-8" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300" itemscope itemtype="https://schema.org/BreadcrumbList">
      {breadcrumbs.map((crumb, index) => (
        <li class="flex items-center" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          {index > 0 && (
            <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
          )}
          {index < breadcrumbs.length - 1 ? (
            <a href={crumb.url} class="hover:text-blue-600 dark:hover:text-blue-400" itemprop="item">
              <span itemprop="name">{crumb.name}</span>
            </a>
          ) : (
            <span class="font-medium text-gray-900 dark:text-white" itemprop="name">{crumb.name}</span>
          )}
          <meta itemprop="position" content={String(index + 1)} />
        </li>
      ))}
    </ol>
  </nav>

  <article class="mx-auto max-w-4xl px-4 py-10 sm:px-6 lg:px-8" itemscope itemtype="https://schema.org/Article">
    <!-- Article Header -->
    <header class="mb-8">
      <div class="mb-4 flex flex-wrap items-center gap-4 text-sm text-gray-700 dark:text-gray-300">
        <a href={`/articles?category=${categoryParam}`} class="rounded-full bg-blue-100 px-3 py-1 font-medium text-blue-800 transition-colors hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800">
          {category}
        </a>
        <time datetime={pubDate.toISOString()} itemprop="datePublished">
          {pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        <span>{readingTime} min read</span>
      </div>

      <h1 class="mb-4 text-3xl font-bold leading-tight tracking-tight text-gray-900 dark:text-white sm:text-4xl md:text-5xl" itemprop="headline">
        {title}
      </h1>

      <p class="text-lg text-gray-700 dark:text-gray-300 sm:text-xl" itemprop="description">
        {description}
      </p>

      <div class="mt-5 rounded-xl border border-blue-200 bg-blue-50/70 p-4 text-sm text-blue-900 shadow-soft dark:border-blue-800/60 dark:bg-blue-950/40 dark:text-blue-200">
        <strong>Brand update:</strong> Openclaw is the new name for Moltbot (formerly Clawdbot). You may still see Moltbot and Clawdbot in docs, tutorials, and community resources.
      </div>

      <div class="mt-4 text-sm text-gray-600 dark:text-gray-300">
        <span class="font-medium text-gray-600 dark:text-gray-300">Quick links:</span>
        <a href="/moltbot-clawdbot" class="ml-2 font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
          Openclaw · Moltbot · Clawdbot
        </a>
        <span class="mx-1 text-gray-500">·</span>
        <a href="/features" class="font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
          Features
        </a>
        <span class="mx-1 text-gray-500">·</span>
        <a href="/articles" class="font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
          Tutorials
        </a>
        <span class="mx-1 text-gray-500">·</span>
        <a href="/hosting" class="font-medium text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
          Hosting
        </a>
      </div>

      <div class="mt-6 flex items-center gap-3" itemprop="author" itemscope itemtype="https://schema.org/Person">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-600 text-white">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </div>
        <div>
          <div class="font-medium text-gray-900 dark:text-white" itemprop="name">{resolvedAuthor}</div>
          <div class="text-sm text-gray-700 dark:text-gray-300">Author</div>
        </div>
      </div>
    </header>

    <!-- Article Content -->
    <div class="article-content prose prose-blue max-w-none md:prose-lg dark:prose-invert prose-headings:font-display prose-headings:font-bold prose-headings:tracking-tight prose-headings:scroll-mt-24 sm:prose-headings:scroll-mt-28 prose-h2:mt-10 prose-h2:mb-4 prose-h3:mt-8 prose-h3:mb-3 prose-h4:mt-6 prose-h4:mb-2 prose-p:leading-relaxed prose-ul:my-4 prose-ol:my-4 prose-li:my-1 prose-hr:my-12 prose-a:text-blue-600 hover:prose-a:text-blue-700 prose-a:no-underline hover:prose-a:underline prose-a:font-medium prose-code:rounded prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:text-sm prose-code:before:content-[''] prose-code:after:content-[''] dark:prose-code:bg-gray-800 prose-pre:rounded-xl prose-pre:border prose-pre:border-gray-800/80 prose-pre:bg-gray-950 prose-pre:text-gray-100 prose-pre:shadow-lg prose-pre:overflow-x-auto dark:prose-pre:border-gray-700 dark:prose-pre:bg-gray-900 prose-img:rounded-lg" itemprop="articleBody">
      <slot />
    </div>

    <!-- Hosting CTA after article content -->
    <div class="my-12">
      <HostingCTAEnhanced context="article" variant="default" />
    </div>

    <!-- Newsletter Signup -->
    <div class="my-12">
      <NewsletterSignup
        variant="inline"
        context="article"
        leadMagnet="Get more Openclaw (Moltbot/Clawdbot) tips in your inbox"
      />
    </div>

    <!-- Article Footer -->
    <footer class="mt-12 space-y-8 border-t border-gray-200 pt-8 dark:border-gray-800">
      <!-- Tags -->
      <div>
        <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-gray-900 dark:text-white">Tags</h3>
        <div class="flex flex-wrap gap-2">
          {keywords?.map((keyword) => (
            <a href={`/articles?tag=${encodeURIComponent(keyword)}`} class="rounded-full bg-gray-100 px-3 py-1 text-sm text-gray-700 transition-colors hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700" title={`Browse articles tagged with ${keyword}`}>
              #{keyword}
            </a>
          ))}
        </div>
      </div>

      <!-- Share Buttons -->
      <div>
        <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-gray-900 dark:text-white">Share Article</h3>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <button type="button" data-copy-link={Astro.url.href} class="flex w-full items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700 sm:w-auto" aria-label="Copy article link" title="Copy article link">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m2 0a2 2 0 00-2-2H9a2 2 0 000 4h6a2 2 0 002-2zm-3 6H8a2 2 0 01-2-2V8a2 2 0 012-2h6" />
            </svg>
            <span data-copy-label>Copy link</span>
          </button>
          <a href={`mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(`${title}\n${Astro.url.href}`)}`} class="flex w-full items-center justify-center gap-2 rounded-lg bg-gray-800 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-gray-900 sm:w-auto" aria-label="Share via email" title="Share this article via email">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email
          </a>
        </div>
      </div>
    </footer>

    <!-- Article Navigation (Previous/Next) -->
    <ArticleNavigation currentSlug={entry.slug} />
  </article>

  <!-- Related Articles Section -->
  <div class="mx-auto max-w-4xl px-4 pb-12 sm:px-6 lg:px-8">
    <RelatedArticles
      currentSlug={entry.slug}
      category={category}
      keywords={keywords}
      maxArticles={3}
      title="You May Also Like"
    />
  </div>

  <!-- Back to Articles -->
  <div class="mx-auto max-w-4xl px-4 pb-12 text-center sm:px-6 lg:px-8">
    <a href="/articles" class="inline-flex items-center gap-2 text-blue-600 transition-colors hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300" title="Browse all Openclaw (Moltbot/Clawdbot) articles and tutorials">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to All Articles
    </a>
  </div>
</BaseLayout>

<script>
  const copyButtons = document.querySelectorAll('[data-copy-link]');
  copyButtons.forEach((button) => {
    const label = button.querySelector('[data-copy-label]');
    const defaultLabel = label?.textContent || 'Copy link';
    button.addEventListener('click', async () => {
      const url = button.getAttribute('data-copy-link') || window.location.href;
      try {
        await navigator.clipboard.writeText(url);
        if (label) {
          label.textContent = 'Copied';
          setTimeout(() => {
            label.textContent = defaultLabel;
          }, 1500);
        }
      } catch {
        window.prompt('Copy link:', url);
      }
    });
  });
</script>

<style is:global>
  /* Custom prose styles for better readability */
  .prose img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }

  .prose pre {
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }

  .prose table {
    display: block;
    max-width: 100%;
    overflow-x: auto;
  }

  .prose table th,
  .prose table td {
    white-space: nowrap;
  }

  .article-content {
    content-visibility: auto;
    contain-intrinsic-size: 1000px;
  }

  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }

  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
