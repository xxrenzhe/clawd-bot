---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ItemListSchema from '../../components/SEO/ItemListSchema.astro';
import BreadcrumbSchema from '../../components/SEO/BreadcrumbSchema.astro';
import { getCollection } from 'astro:content';

const allArticles = await getCollection('articles');
const sortedArticles = allArticles.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const categories = ['All', 'Tutorial', 'Guide', 'Comparison', 'Best Practices', 'News', 'Advanced'];

const baseUrl = Astro.site?.href?.replace(/\/$/, '') || 'https://clawd-bot.app';

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Articles', url: '/articles' },
];

const listItems = sortedArticles.map((article, index) => ({
  title: article.data.title,
  url: `${baseUrl}/articles/${article.slug}`,
  description: article.data.description,
  image: article.data.image ? `${baseUrl}${article.data.image}` : undefined,
  position: index + 1,
}));
---

<BaseLayout
  title="OpenClaw (Moltbot/Clawdbot) Articles & Tutorials | Guides, How-tos & Best Practices"
  description="Browse comprehensive guides, tutorials, and best practices for using OpenClaw (formerly Moltbot/Clawdbot). Learn how to set up, configure, and optimize your AI assistant for maximum productivity."
  keywords={['openclaw tutorials', 'openclaw guides', 'openclaw documentation', 'moltbot tutorials', 'moltbot guides', 'moltbot documentation', 'clawdbot tutorials', 'clawdbot guides', 'AI assistant setup', 'clawdbot documentation', 'clawdbot how to', 'discord bot tutorials']}
>
  <ItemListSchema
    name="OpenClaw (Moltbot/Clawdbot) Articles & Tutorials"
    description="Comprehensive collection of guides, tutorials, and best practices for the OpenClaw (Moltbot/Clawdbot) AI assistant"
    items={listItems}
    itemType="TechArticle"
  />
  <BreadcrumbSchema items={breadcrumbs} />
  <section class="relative overflow-hidden bg-gradient-to-br from-blue-50 via-white to-indigo-100 py-16 dark:from-gray-950 dark:via-gray-900 dark:to-indigo-950 sm:py-20">
    <div class="pointer-events-none absolute -top-24 left-[-6rem] h-64 w-64 rounded-full bg-blue-200/40 blur-3xl dark:bg-blue-500/10"></div>
    <div class="pointer-events-none absolute bottom-[-10rem] right-[-4rem] h-72 w-72 rounded-full bg-teal-200/40 blur-3xl dark:bg-teal-500/10"></div>
    <div class="mx-auto max-w-4xl px-4 text-center sm:px-6 lg:px-8">
      <span class="inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-1 text-sm font-semibold text-blue-700 shadow-sm ring-1 ring-gray-200 dark:bg-gray-900/70 dark:text-blue-300 dark:ring-gray-700">
        Knowledge Base
      </span>
      <h1 class="mb-6 mt-4 text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl md:text-5xl">
        Articles & Tutorials
      </h1>
      <p class="text-base text-gray-700 dark:text-gray-300 sm:text-lg md:text-xl">
        Everything you need to know about OpenClaw (Moltbot/Clawdbot), from setup to advanced usage.
      </p>
    </div>
  </section>

  <section class="py-12 sm:py-16">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <!-- Category Filter -->
      <div class="section-panel rounded-3xl p-6 sm:p-8">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Browse by Topic</h2>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
              Filter the library by category to find the best next steps for your workflow.
            </p>
          </div>
          <div class="flex gap-3 overflow-x-auto pb-2 -mx-2 px-2 sm:flex-wrap sm:overflow-visible sm:pb-0">
            {categories.map((category) => (
              <button
                type="button"
                class="category-filter whitespace-nowrap rounded-full border border-gray-300/80 bg-white/70 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm transition-colors hover:border-blue-500 hover:text-blue-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500/40 dark:border-gray-700/80 dark:bg-gray-900/60 dark:text-gray-200 dark:hover:border-blue-400 dark:hover:text-blue-300"
                data-category={category}
                aria-pressed="false"
              >
                {category}
              </button>
            ))}
          </div>
        </div>
      </div>

      <div id="active-filter" class="mt-4 hidden text-center text-sm text-gray-700 dark:text-gray-300" role="status" aria-live="polite"></div>

      <!-- Articles Grid -->
      <div class="mt-8 grid gap-8 md:grid-cols-2 lg:grid-cols-3 reveal-group sm:mt-10">
        {sortedArticles.map((article) => (
          <article
            class="article-card group surface-card rounded-2xl transition-transform transition-shadow hover:-translate-y-1 hover:shadow-float"
            data-category={article.data.category}
            data-tags={article.data.keywords.join('|')}
          >
            <a href={`/articles/${article.slug}`} class="block">
              <div class="p-6">
                <div class="mb-3 flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                  <span class="rounded-full bg-blue-100/80 px-2.5 py-1 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    {article.data.category}
                  </span>
                  <span>{article.data.readingTime} min read</span>
                </div>
                <h2 class="mb-2 text-xl font-bold text-gray-900 transition-colors group-hover:text-blue-600 dark:text-white dark:group-hover:text-blue-400">
                  {article.data.title}
                </h2>
                <p class="mb-4 text-gray-700 dark:text-gray-300">
                  {article.data.description}
                </p>
                <div class="flex items-center justify-between">
                  <time
                    datetime={article.data.pubDate.toISOString()}
                    class="text-sm text-gray-600 dark:text-gray-400"
                  >
                    {article.data.pubDate.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>
                  <div class="flex items-center gap-2 text-sm font-medium text-blue-600 dark:text-blue-400">
                    Read More
                    <svg
                      class="h-4 w-4 transition-transform group-hover:translate-x-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      aria-hidden="true"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 7l5 5m0 0l-5 5m5-5H6"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>
            </a>
          </article>
        ))}
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden py-16 text-center" role="status" aria-live="polite">
        <div class="surface-card mx-auto max-w-xl rounded-2xl p-8">
          <svg
            class="mx-auto mb-4 h-16 w-16 text-gray-500"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <p class="text-lg font-semibold text-gray-900 dark:text-white">
            No articles found in this category.
          </p>
          <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">
            Try another filter or clear the selection to see all articles.
          </p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  const filterButtons = document.querySelectorAll<HTMLElement>('.category-filter');
  const articleCards = document.querySelectorAll<HTMLElement>('.article-card');
  const emptyState = document.getElementById('empty-state');
  const activeFilter = document.getElementById('active-filter');

  const normalize = (value: string | null | undefined) => (value || '').toLowerCase().trim();

  const setActiveButton = (category: string | null) => {
    const target = normalize(category || 'All');
    filterButtons.forEach((btn) => {
      const isActive = normalize(btn.getAttribute('data-category')) === target;
      btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      btn.classList.toggle('border-blue-600', isActive);
      btn.classList.toggle('text-blue-700', isActive);
      btn.classList.toggle('bg-white', isActive);
      btn.classList.toggle('dark:border-blue-400', isActive);
      btn.classList.toggle('dark:text-blue-300', isActive);
      btn.classList.toggle('dark:bg-gray-900/80', isActive);
      btn.classList.toggle('border-gray-300/80', !isActive);
      btn.classList.toggle('text-gray-700', !isActive);
      btn.classList.toggle('bg-white/70', !isActive);
      btn.classList.toggle('dark:border-gray-700/80', !isActive);
      btn.classList.toggle('dark:text-gray-200', !isActive);
      btn.classList.toggle('dark:bg-gray-900/60', !isActive);
    });
  };

  const updateActiveFilter = (category: string | null, tag: string | null) => {
    if (!activeFilter) return;
    const parts = [];
    if (category && normalize(category) !== 'all') {
      parts.push(`Category: ${category}`);
    }
    if (tag) {
      parts.push(`Tag: ${tag}`);
    }
    if (parts.length === 0) {
      activeFilter.textContent = '';
      activeFilter.classList.add('hidden');
      return;
    }
    activeFilter.textContent = `Filtered by ${parts.join(' | ')}`;
    activeFilter.classList.remove('hidden');
  };

  const filterArticles = (category: string | null, tag: string | null) => {
    const normalizedCategory = normalize(category);
    const normalizedTag = normalize(tag);
    const useCategory = normalizedCategory && normalizedCategory !== 'all';

    let visibleCount = 0;
    articleCards.forEach((card) => {
      const articleCategory = normalize(card.getAttribute('data-category'));
      const tagList = (card.getAttribute('data-tags') || '')
        .split('|')
        .map(normalize)
        .filter(Boolean);

      const matchesCategory = !useCategory || articleCategory === normalizedCategory;
      const matchesTag = !normalizedTag || tagList.includes(normalizedTag);

      if (matchesCategory && matchesTag) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    if (visibleCount === 0) {
      emptyState?.classList.remove('hidden');
    } else {
      emptyState?.classList.add('hidden');
    }
  };

  const applyFilter = (category: string | null, tag: string | null, updateUrl = false) => {
    filterArticles(category, tag);
    setActiveButton(category || 'All');
    updateActiveFilter(category, tag);

    if (updateUrl) {
      const params = new URLSearchParams();
      if (category && normalize(category) !== 'all') {
        params.set('category', category);
      }
      if (tag) {
        params.set('tag', tag);
      }
      const query = params.toString();
      const nextUrl = query ? `${window.location.pathname}?${query}` : window.location.pathname;
      window.history.replaceState({}, '', nextUrl);
    }
  };

  filterButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');

      applyFilter(category, null, true);
    });
  });

  const params = new URLSearchParams(window.location.search);
  const initialCategory = params.get('category');
  const initialTag = params.get('tag');

  if (initialCategory || initialTag) {
    applyFilter(initialCategory || 'All', initialTag, false);
  } else {
    setActiveButton('All');
  }
</script>
